{% extends "base.html" %}
{% block title %}Select Metric | CMD{% endblock %}

{% block content %}
<style>
    .metrics-layout {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .metrics-list, .metric-summary {
        flex: 1;
        min-width: 300px;
    }

    .metric-card {
        border: 1px solid #ccc;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        cursor: pointer;
    }

    .metric-card:hover {
        background-color: #f8f8f8;
    }

    .metrics-scroll-box {
        max-height: 450px;
        overflow-y: auto;
        padding-right: 0.25rem;
    }

    .summary-box {
        border: 1px solid #007bff;
        padding: 1rem;
        border-radius: 8px;
        background-color: #e9f5ff;
    }
</style>

<div class="page-wrapper">
    <div class="form-container">
        <div class="form-wrapper">
            <h4 class="fw-bold mb-4">Step 2: Select a Fairness Metric</h4>
            <p class="text-muted mb-4">Choose one metric that best aligns with your fairness goal.</p>

            <div class="metrics-layout">

                <div class="metrics-list">
                    <h5 class="fw-semibold mb-3">Available Metrics</h5>
                    <div class="metrics-scroll-box">
                        {% for metric in metrics %}
                        <div class="metric-card" onclick="selectMetric('{{ metric.id }}')">
                            <strong>{{ metric.name }}</strong>
                            <p class="text-muted" style="font-size: 0.9rem;">{{ metric.explanation }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="metric-summary">
                    <h5 class="fw-semibold mb-3">Selected Metric</h5>
                    <div class="summary-box" id="metric-summary">
                        <p class="text-muted mb-0" id="no-selection">No metric selected yet.</p>
                    </div>
                </div>

            </div>

            <form method="POST" id="metric-form">
                {% csrf_token %}
                <input type="hidden" name="selected_metric" id="selected-metric-input">
                <div class="text-end mt-4">
                    <button type="button" onclick="submitMetricForm()" class="btn btn-success rounded-pill px-5 py-3 fs-5">
                        Next
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<script>
        const metrics = {{ metrics|safe }};
    {% if selected_metric_id %}
        let selectedMetricId = "{{ selected_metric_id }}";
    {% else %}
        let selectedMetricId = null;
    {% endif %}

    function renderSelectedMetric() {
        if (!selectedMetricId) return;

        const metric = metrics.find(m => m.id === selectedMetricId);
        if (!metric) return;

        const summary = document.getElementById("metric-summary");
        summary.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${metric.name}</strong>
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">${metric.explanation}</p>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="clearSelection()">Remove</button>
            </div>
        `;
    }

    function selectMetric(id) {
        selectedMetricId = id;
        renderSelectedMetric();
    }

    function clearSelection() {
        selectedMetricId = null;
        const summary = document.getElementById("metric-summary");
        summary.innerHTML = `<p class="text-muted mb-0" id="no-selection">No metric selected yet.</p>`;
    }

    function submitMetricForm() {
        if (!selectedMetricId) {
            alert("Please select a metric before continuing.");
            return;
        }
        document.getElementById("selected-metric-input").value = selectedMetricId;
        document.getElementById("metric-form").submit();
    }

    window.addEventListener("DOMContentLoaded", renderSelectedMetric);
</script>
{% endblock %}
