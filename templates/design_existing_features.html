{% extends "base.html" %}
{% block title %}Select Features | CMD{% endblock %}

{% block content %}
<style>
    .features-layout {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .features-list, .feature-config, .feature-summary {
        flex: 1;
        min-width: 300px;
    }

    .feature-card {
        border: 1px solid #ccc;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        cursor: pointer;
    }

    .feature-card:hover {
        background-color: #f8f8f8;
    }

    .features-scroll-box {
        max-height: 450px;
        overflow-y: auto;
        padding-right: 0.25rem;
    }

    .summary-box {
        border: 1px solid #007bff;
        padding: 1rem;
        border-radius: 8px;
        background-color: #e9f5ff;
    }

    .binning-option {
        margin-top: 1rem;
    }

    .btn-bin {
        margin-top: 1rem;
    }
</style>

<div class="page-wrapper">
    <div class="form-container">
        <div class="form-wrapper">
            <h4 class="fw-bold mb-4">Step 1: Select Features and Binning</h4>
            <p class="text-muted mb-4">Choose the features you want to protect and define their protected and non-protected ranges or groups.</p>

            <div class="features-layout">

                <div class="features-list">
                    <h5 class="fw-semibold mb-3">Available Features</h5>
                    <div class="features-scroll-box">
                        {% for feature in features %}
                        <div class="feature-card" onclick="selectFeature('{{ feature.name }}')">
                            <strong>{{ feature.name }}</strong>
                            <p class="text-muted" style="font-size: 0.9rem;">{{ feature.explanation }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="feature-config">
                    <h5 class="fw-semibold mb-3">Bin the Feature</h5>
                    <div id="config-box">
                        <p class="text-muted">Click a feature to select binning options for both protected and non-protected groups.</p>
                    </div>
                </div>

                <div class="feature-summary">
                    <h5 class="fw-semibold mb-3">Selected Features</h5>
                    <div class="summary-box">
                        <ul id="summary-list" class="list-unstyled mb-0">
                            <li class="text-muted" id="empty-msg">No features selected yet.</li>
                        </ul>
                    </div>
                </div>

            </div>

            <form method="POST" id="feature-form">
                {% csrf_token %}
                <input type="hidden" name="features" id="feature-input" />
                <div class="text-end mt-4">
                    <button type="button" onclick="submitForm()" class="btn btn-success rounded-pill px-5 py-3 fs-5">
                        Next
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<script>
    const allFeatures = {{ features|safe }};
    const selectedFeatures = new Map();

    const selectedFromServer = {{ selected_features|safe }};

    for (const item of selectedFromServer) {
        
        const match = item.match(/^(.+?)\[(.+?)\]\[(.+?)\]$/);
        console.log(match);
        if (match) {
            const name = match[1];
            const binText = match[2];
            const status = match[3];
            const binKey = `${name}::${binText.replace(/\s+/g, '')}`;
            selectedFeatures.set(binKey, { name, binText, status });
        }
    }

    window.addEventListener("DOMContentLoaded", () => {
        const summaryList = document.getElementById("summary-list");
        const emptyMsg = document.getElementById("empty-msg");
        if (emptyMsg) emptyMsg.remove();

        for (const [key, value] of selectedFeatures.entries()) {
            const li = document.createElement("li");
            li.className = "border-bottom py-2 d-flex justify-content-between align-items-center";
            li.id = `feature-${key.replace(/\W+/g, '-')}`;
            li.innerHTML = `
                <div>
                    <strong>${value.name}</strong>
                    <span class="text-muted ms-2">[${value.binText}]
                    ${value.status === 'protected' ? '&#9989;' : '&#10060;'}
                    </span>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeFeature('${key}')">Delete</button>
            `;
            summaryList.appendChild(li);
        }

        if (selectedFeatures.size === 0 && summaryList) {
            const emptyMsg = document.createElement("li");
            emptyMsg.className = "text-muted";
            emptyMsg.id = "empty-msg";
            emptyMsg.textContent = "No features selected yet.";
            summaryList.appendChild(emptyMsg);
        }
    });

    function getBinningKey(name, min, max, cats) {
        if (!min && !max && !cats) return `${name}::ALL`;
        if (cats) return `${name}::${cats.join("|")}`;
        return `${name}::${min || ''}-${max || ''}`;
    }

    function featureHasAll(name) {
        return Array.from(selectedFeatures.keys()).some(k => k === `${name}::ALL`);
    }

    function featureHasOtherBinning(name) {
        return Array.from(selectedFeatures.keys()).some(k => k.startsWith(`${name}::`) && k !== `${name}::ALL`);
    }

    function selectFeature(name) {
        const feature = allFeatures.find(f => f.name === name);
        if (!feature) return;

        let inputHTML = "";

        if (feature.type === "numerical") {
            inputHTML = `
                <input type="number" class="form-control mb-2" id="binMin" placeholder="Min (${feature.min})" min="${feature.min}" max="${feature.max}">
                <input type="number" class="form-control" id="binMax" placeholder="Max (${feature.max})" min="${feature.min}" max="${feature.max}">
            `;
            inputHTML2 = `
                <input type="number" class="form-control mb-2" id="binMin2" placeholder="Min (${feature.min})" min="${feature.min}" max="${feature.max}">
                <input type="number" class="form-control" id="binMax2" placeholder="Max (${feature.max})" min="${feature.min}" max="${feature.max}">
            `;
        } else if (feature.type === "categorical") {
            const options = feature.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            inputHTML = `
                <select class="form-select" id="binCategorySingle">
                    ${options}
                </select>
            `;
            inputHTML2 = `
                <select class="form-select" id="binCategorySingle2">
                    ${options}
                </select>
            `;
        }

        document.getElementById("config-box").innerHTML = `
            <p><strong>${name}</strong></p>
            <p><strong>Select the Group you want to protect.</strong></p>
            <!--  
            <div class="form-check">
                <input class="form-check-input" type="radio" name="binning" id="binAll" value="all" checked>
                <label class="form-check-label" for="binAll">All</label>
            </div>
            <div class="form-check mt-2">
                <input class="form-check-input" type="radio" name="binning" id="binRange" value="range">
                <label class="form-check-label" for="binRange">Custom</label>
            </div>
            -->


            <div class="d-flex align-items-start mt-3">
                <div class="binning-option me-2 w-50" id="binning-options">
                    ${inputHTML}
                </div>
                <button class="btn btn-primary btn-bin" onclick="addToSummary('${name}', '${feature.type}', 'protected')">Add</button>
            </div>
            <hr>
            <p><strong>Select the Group you don't want to protect.</strong></p>

            <div class="d-flex align-items-start mt-3">
                <div class="binning-option me-2 w-50" id="binning-options2">
                    ${inputHTML2}
                </div>
                <button class="btn btn-primary btn-bin mt-3" onclick="addToSummary('${name}', '${feature.type}', 'non-protected')">Add</button>
            </div>
        `;

        document.querySelectorAll('input[name="binning"]').forEach(r => {
            r.addEventListener('change', () => {
                const optionsBox = document.getElementById('binning-options');
                optionsBox.style.display = document.getElementById('binAll').checked ? 'none' : 'block';
            });
            r.dispatchEvent(new Event('change'));
        });
    }

    function addToSummary(name, type, status) {

        const isAll = false;

        let binText = "All";
        let binKey = `${name}::ALL`;

        if (status == 'protected') {
            if (type === "numerical") {
                const min = document.getElementById("binMin").value.trim();
                const max = document.getElementById("binMax").value.trim();
                binText = `${min || '—'} to ${max || '—'}`;
                binKey = getBinningKey(name, min, max);
            } else if (type === "categorical") {
                const selected = document.getElementById("binCategorySingle").value;
                if (!selected) {
                    alert("Please select a category.");
                    return;
                }
                binText = selected;
                binKey = getBinningKey(name, null, null, [selected]);
            }
        }

        else if (status == 'non-protected') {
            if (type === "numerical") {
                const min = document.getElementById("binMin2").value.trim();
                const max = document.getElementById("binMax2").value.trim();
                binText = `${min || '—'} to ${max || '—'}`;
                binKey = getBinningKey(name, min, max);
            } else if (type === "categorical") {
                const selected = document.getElementById("binCategorySingle2").value;
                
                if (!selected) {
                    alert("Please select a category.");
                    return;
                }
                binText = selected;
                binKey = getBinningKey(name, null, null, [selected]);
            }
        }

        console.log(selectedFeatures);

        if (selectedFeatures.has(binKey)) {
            alert("This feature with the same binning is already selected.");
            return;
        }

        if (isAll && featureHasOtherBinning(name)) {
            alert(`You already added specific bins for "${name}". Cannot add 'All'.`);
            return;
        }

        if (!isAll && featureHasAll(name)) {
            alert(`"${name}" is already added as 'All'. Cannot add bins.`);
            return;
        }

        selectedFeatures.set(binKey, { name, binText, status });

        const summaryList = document.getElementById("summary-list");
        const emptyMsg = document.getElementById("empty-msg");
        if (emptyMsg) emptyMsg.remove();

        const li = document.createElement("li");
        li.className = "border-bottom py-2 d-flex justify-content-between align-items-center";
        li.id = `feature-${binKey.replace(/\W+/g, '-')}`;
        li.innerHTML = `
            <div>
                <strong>${name}</strong>
                <span class="text-muted ms-2">[${binText}] ${status === 'protected' ? '&#9989;' : '&#10060;'} </span>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeFeature('${binKey}')">Delete</button>
        `;
        summaryList.appendChild(li);
    }

    function removeFeature(key) {
        const li = document.getElementById(`feature-${key.replace(/\W+/g, '-')}`);
        if (li) li.remove();
        selectedFeatures.delete(key);

        const summaryList = document.getElementById("summary-list");
        if (selectedFeatures.size === 0) {
            const emptyMsg = document.createElement("li");
            emptyMsg.className = "text-muted";
            emptyMsg.id = "empty-msg";
            emptyMsg.textContent = "No features selected yet.";
            summaryList.appendChild(emptyMsg);
        }
    }
    function generateFeatureString() {
        const finalArray = Array.from(selectedFeatures.entries()).map(([key, value]) => {
            return `${value.name}[${value.binText}][${value.status}]`;
        });
        return finalArray.join(",");
    }

    function submitForm() {
        const featureString = generateFeatureString();
        document.getElementById("feature-input").value = featureString;
        document.getElementById("feature-form").submit();
    }
</script>
{% endblock %}
